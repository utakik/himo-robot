<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tilt Control – Himo Robot</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;line-height:1.5}
  h1{font-size:1.4rem;margin:0 0 12px}
  nav a{margin-right:8px}
  .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  label{font-size:.9rem}
  input,select,button{font-size:1rem;padding:.6rem .7rem;border:1px solid #ccc;border-radius:10px}
  button{cursor:pointer}
  .num{font-variant-numeric:tabular-nums}
  .ok{color:#0a7f3f}.warn{color:#c75000}.err{color:#b00020}.mono{font-family:ui-monospace,SFMono-Regular,Consolas,monospace}
  .small{font-size:.85rem;opacity:.75}
</style>
</head>
<body>
<nav>
  <a href="index.html">Home</a> |
  <a href="tilt.html"><b>Tilt Control</b></a> |
  <a href="led.html">LED Test</a> |
<a href="https://utakik.github.io/robot-notes-/" target="_blank" rel="noopener">Robot Notes</a>
</nav>
 
<h1>スマホの傾きを送る（Tilt Control）</h1>
 
<div class="card">
  <p class="small">iOS はセンサー利用前に許可が必要です。</p>
  <button id="btn-perm">センサーの使用を許可する</button>
  <span id="perm-status" class="small"></span>
</div>
 
<div class="card">
  <div class="row">
    <div>
      <label>送信方式</label><br/>
      <select id="mode">
        <option value="ws">WebSocket（低遅延）</option>
        <option value="http">HTTP（/tilt?x=&y=&z=）</option>
      </select>
    </div>
    <div id="ws-box">
      <label>WS サーバー（例: ws://192.168.0.50:81）</label><br/>
      <input id="ws-url" size="34" placeholder="ws://esp32.local:81" />
      <button id="btn-ws">接続/切断</button>
    </div>
    <div id="http-box" style="display:none">
HTTP ベースURL（例: http://192.168.0.50）</label><br/>
<input id="http-url? size="34? placeholder="http://esp32.local" />
    </div>
  </div>
  <div class="small">状態: <span id="conn" class="mono">-</span></div>
</div>
 
<div class="card">
  <div class="row">
    <div>
      <label>送信間隔 (ms)</label><br/>
      <input id="interval" type="number" value="50" min="16" step="1" />
    </div>
    <div>
      <label>スムージング</label><br/>
      <input id="alpha" type="number" value="0.15" step="0.05" min="0" max="0.9" />
    </div>
    <div>
      <label>感度（倍率）</label><br/>
      <input id="gain" type="number" value="1.0" step="0.1" min="0.1" max="5" />
    </div>
  </div>
</div>
 
<div class="card">
  <div class="row">
    <div>
      <b>傾き（DeviceOrientation）</b><br/>
      alpha(方位): <span id="oAlpha" class="num mono">-</span><br/>
      beta(前後): <span id="oBeta" class="num mono">-</span><br/>
      gamma(左右): <span id="oGamma" class="num mono">-</span>
    </div>
    <div>
      <b>加速度（DeviceMotion）</b><br/>
      ax: <span id="ax" class="num mono">-</span><br/>
      ay: <span id="ay" class="num mono">-</span><br/>
      az: <span id="az" class="num mono">-</span>
    </div>
    <div>
      <b>送信中の値</b><br/>
      x: <span id="sx" class="num mono">-</span><br/>
      y: <span id="sy" class="num mono">-</span><br/>
      z: <span id="sz" class="num mono">-</span>
    </div>
  </div>
</div>
 
<script>
(() => {
  const btnPerm = document.getElementById('btn-perm');
  const permStatus = document.getElementById('perm-status');
  const modeSel = document.getElementById('mode');
  const wsBox = document.getElementById('ws-box');
  const httpBox = document.getElementById('http-box');
  const wsUrl = document.getElementById('ws-url');
  const httpUrl = document.getElementById('http-url');
  const btnWS = document.getElementById('btn-ws');
  const connEl = document.getElementById('conn');
  const intervalEl = document.getElementById('interval');
  const alphaEl = document.getElementById('alpha');
  const gainEl = document.getElementById('gain');
 
  const oAlpha = document.getElementById('oAlpha');
  const oBeta  = document.getElementById('oBeta');
  const oGamma = document.getElementById('oGamma');
  const axEl = document.getElementById('ax');
  const ayEl = document.getElementById('ay');
  const azEl = document.getElementById('az');
  const sxEl = document.getElementById('sx');
  const syEl = document.getElementById('sy');
  const szEl = document.getElementById('sz');
 
  let ori = {alpha:0,beta:0,gamma:0};
  let acc = {x:0,y:0,z:0};
  let filt = {x:0,y:0,z:0};
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
 
  let ws = null;
  function setConn(status, cls=''){ connEl.textContent=status; connEl.className='mono '+cls; }
 
  btnPerm.onclick = async () => {
    try {
      let ok1 = true, ok2 = true;
      if (typeof DeviceMotionEvent !== 'undefined' &&
          typeof DeviceMotionEvent.requestPermission === 'function') {
        ok1 = (await DeviceMotionEvent.requestPermission()) === 'granted';
      }
      if (typeof DeviceOrientationEvent !== 'undefined' &&
          typeof DeviceOrientationEvent.requestPermission === 'function') {
        ok2 = (await DeviceOrientationEvent.requestPermission()) === 'granted';
      }
      if (ok1 && ok2){ permStatus.textContent='許可されました ✅'; permStatus.className='small ok'; startSensors(); }
      else { permStatus.textContent='許可されませんでした ❌'; permStatus.className='small err'; }
    } catch(e) {
      permStatus.textContent='この端末は許可不要です ✅'; permStatus.className='small ok'; startSensors();
    }
  };
 
  function startSensors(){
    window.addEventListener('deviceorientation',(e)=>{
      if (e.alpha!=null) ori.alpha=e.alpha;
      if (e.beta !=null) ori.beta =e.beta;
      if (e.gamma!=null) ori.gamma=e.gamma;
      oAlpha.textContent=ori.alpha.toFixed(1);
      oBeta.textContent =ori.beta.toFixed(1);
      oGamma.textContent=ori.gamma.toFixed(1);
    },true);
 
    window.addEventListener('devicemotion',(e)=>{
      const a=e.accelerationIncludingGravity||e.acceleration||{x:0,y:0,z:0};
      acc.x=a.x||0; acc.y=a.y||0; acc.z=a.z||0;
      axEl.textContent=acc.x.toFixed(3);
      ayEl.textContent=acc.y.toFixed(3);
      azEl.textContent=acc.z.toFixed(3);
    },true);
 
    tick();
  }
 
  async function tick(){
    const dt=parseInt(intervalEl.value||'50',10);
    const a =parseFloat(alphaEl.value ||'0.15');
    const g =parseFloat(gainEl .value ||'1');
 
    filt.x += a*((ori.gamma*g)-filt.x);
    filt.y += a*((ori.beta *g)-filt.y);
    filt.z += a*((ori.alpha*g)-filt.z);
 
    const sx=clamp(filt.x,-90,90);
    const sy=clamp(filt.y,-90,90);
    const sz=((filt.z%360)+360)%360;
 
    sxEl.textContent=sx.toFixed(1);
    syEl.textContent=sy.toFixed(1);
    szEl.textContent=sz.toFixed(1);
 
    if (modeSel.value==='ws'){
      if (ws && ws.readyState===1){ ws.send(JSON.stringify({x:sx,y:sy,z:sz})); }
    } else {
      const base=(httpUrl.value||'').trim();
      if (base){
        const u=`${base.replace(/\/$/,'')}/tilt?x=${sx.toFixed(1)}&y=${sy.toFixed(1)}&z=${sz.toFixed(1)}`;
        fetch(u).catch(()=>{});
      }
    }
    setTimeout(tick,dt);
  }
 
  modeSel.onchange=()=>{
    const m=modeSel.value;
wsBox.style.display=(m==='ws')?'':'none';
httpBox.style.display=(m==='http')?'':'none';
    setConn('-', '');
  };
 
  btnWS.onclick=()=>{
    if (ws && ws.readyState===1){ ws.close(); return; }
    const url=(wsUrl.value||'').trim();
    if (!url){ alert('WebSocketのURLを入力してください（例: ws://192.168.0.50:81）'); return; }
    try{
      ws=new WebSocket(url);
      setConn('接続中...','warn');
      ws.onopen =()=>setConn('接続中（OPEN）','ok');
      ws.onclose=()=>setConn('切断','');
      ws.onerror=()=>setConn('エラー','err');
      ws.onmessage=(ev)=>{/* ESP32からの返信を扱うならここ */}
    }catch(e){ setConn('URLエラー','err'); }
  };
 
  setConn('-', '');
})();
</script>
 
</body>
</html>
